for(var maxColnum=11,maxRownum=10,mydata=[],colOption=[],i=0;i<maxColnum;i++){mydata[i]=[];for(var j=0;j<maxRownum;j++)mydata[i][j]="";colOption[i]={readOnly:!0}}colOption[0]={readOnly:!1};var container=document.getElementById("main"),handsontable=new Handsontable(container,{width:980,height:240,data:mydata,rowHeaders:!0,colHeaders:["\u30e4\u30d5\u30aa\u30af\u5546\u54c1URL","\u5546\u54c1\u30bf\u30a4\u30c8\u30eb","\u30aa\u30fc\u30af\u30b7\u30e7\u30f3ID","\u73fe\u5728\u4fa1\u683c","\u5373\u6c7a\u4fa1\u683c","\u72b6\u614b","\u5165\u672d\u4ef6\u6570","\u6b8b\u308a\u6642\u9593","\u753b\u50cf1","\u753b\u50cf2","\u753b\u50cf3"],maxCols:maxColnum,maxRows:maxRownum,manualColumnResize:!0,autoColumnSize:!1,colWidths:[200,300,150,120,120,120,120,120,120,120,120],columns:colOption}),csv_container=document.getElementById("csv"),idata=gon.csv_head,ini=idata,csv_handsontable=new Handsontable(csv_container,{width:980,height:240,data:idata,rowHeaders:!0,colHeaders:!0,maxRows:maxRownum,manualColumnResize:!0,autoColumnSize:!1,wordWrap:!1});csv_handsontable.alter("insert_row",idata.length,10);var selected_container=document.getElementById("selected"),init=[];init[0]=[],init[0][0]="";var selected_handsontable=new Handsontable(selected_container,{width:380,height:60,colWidths:[340],data:init,colHeaders:["\u9078\u629e\u4e2d\u306e\u30bb\u30eb"],rowHeaders:!1,maxRows:1,manualColumnResize:!0,autoColumnSize:!0,wordWrap:!1});Handsontable.hooks.add("afterSelectionEnd",function(){var a=csv_handsontable.getValue(),e=[];e[0]=[],e[0][0]=a,selected_handsontable.loadData(e),selected_handsontable.render()},csv_handsontable),$("#done").click(function(){var a=handsontable.getData();a=JSON.stringify(a),myData={data:a},$.ajax({url:"/items/get",type:"POST",data:myData,dataType:"json",success:function(a){handsontable.loadData(a),handsontable.updateSettings({maxRows:maxRownum})},error:function(){alert("NG")}})}),$("#make_csv").click(function(){var a=handsontable.getData();$.ajax({url:"/items/set_csv",type:"GET",success:function(e){var t=csv_handsontable.getData(),n=3,o=new Date,r=(o.getMonth()+1).toString(10),i=o.getDate().toString(10),d=o.getHours().toString(10),l=o.getMinutes().toString(10);r=("0"+r).slice(-2),i=("0"+i).slice(-2),d=("0"+d).slice(-2),l=("0"+l).slice(-2);for(var s=r+i+d+l,c=0;c<a.length;c++)if(""==a[c][0]){var m=c;break}for(var u=e.price,v=(e.title,e.fixed),h=e.keyword,_={},g=[],f=0;f<n;f++)if(g[f]=t[f],2==f)for(var c=0;c<t[f].length;c++)_[t[f][c]]=c;for(var y={},w={},c=0;c<v.length;c++)w[v[c][0]]=v[c][1];for(var c=0;c<h.length;c++){var b=[];b[0]=h[c][1],b[1]=h[c][2],b[2]=h[c][3],y[h[c][0]]=b}if(0!=m)for(var f=0;f<m;f++){g[f+n]=[];for(var p=0;p<t[2].length;p++)g[f+n][p]="";var x=!1;for(key in y){var k=a[f][1].indexOf(key);if(k>-1){var D=y[key];x=!0;break}}var S=a[f][4];0==S&&(S=a[f][3]);for(var R=0;R<u.length;R++)if(u[R][0]>S){S=u[R-1][1]+(u[R][1]-u[R-1][1])/(u[R][0]-u[R-1][0])*(S-u[R-1][0]);break}g[f+n][_.item_sku]=a[f][2],g[f+n][_.item_name]=a[f][1],g[f+n][_.standard_price]=S,g[f+n][_.main_image_url]=a[f][8],g[f+n][_.other_image_url1]=a[f][9],g[f+n][_.other_image_url2]=a[f][10];var C=("000"+f).slice(-3);g[f+n][_.external_product_id]=s+C,g[f+n][_.external_product_id_type]="EAN";for(var H=0;H<v.length;H++)v[H][0]in _&&(g[f+n][_[v[H][0]]]=v[H][1]);1==x&&(g[f+n][_.brand_name]=D[0],g[f+n][_.manufacturer]=D[1],g[f+n][_.recommended_browse_nodes]=D[2],g[f+n][_.generic_keywords]=D[3]),g[f+n][_.product_description]=a[f][1]+"\u3067\u3059\u3002",g[f+n][_.update_delete]="Update"}csv_handsontable.loadData(g),alert("CSV\u4f5c\u6210")},error:function(){alert("NG")}})}),$("#csv_upload").click(function(){var a=csv_handsontable.getData();a=JSON.stringify(a),myData={data:a},$.ajax({url:"/items/upload",type:"POST",data:myData,dataType:"json",success:function(){alert("\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u3066\u3044\u307e\u3059")},error:function(){}})});